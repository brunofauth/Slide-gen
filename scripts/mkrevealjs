#! /bin/sh


md_with_extensions=markdown
md_with_extensions="$md_with_extensions+all_symbols_escapable"
md_with_extensions="$md_with_extensions+auto_identifiers"
# md_with_extensions="$md_with_extensions+implicit_figures"
md_with_extensions="$md_with_extensions+fenced_divs"
md_with_extensions="$md_with_extensions+fancy_lists"


pandoc_options=

# Produce output with an appropriate header and footer (e.g. a standalone HTML,
# LaTeX, TEI, or RTF file, not a fragment).
pandoc_options="$pandoc_options --standalone"

# When using html/css/js-based slide writers, pandoc will look for the css/js
# files around the cwd. If it does not find them, it will just LINK (<script
# src=...>) these needed files to some URL out there. This option makes pandoc
# download them at 'compile-time' and embed them in the final file
# --> pandoc(1) ยง Options affecting specific writers
pandoc_options="$pandoc_options --embed-resources=true"

# Include an automatically generated TOC in the output document. This option
# has no effect unless -s/--standalone is used, and it has no effect on man,
# docbook4, docbook5, or jats output.
pandoc_options="$pandoc_options --table-of-contents"

# Number section headings in LaTeX, ConTeXt, HTML, Docx, ms, or EPUB output. By
# default, sections are not numbered.
# --> pandoc(1) ยง Options affecting specific writers
pandoc_options="$pandoc_options --number-section"

# Headings above this level in the hierarchy are used to divide the slide show
# into sections; headings below this level create subheads within a slide. 
# --> pandoc(1) ยง Structuring the slide show
pandoc_options="$pandoc_options --slide-level=2"


main() {
    local input_file="$1"
    local _input_file_basename="$(basename "$input_file")"
    local output_file="$(dirname "$input_file")/output/${_input_file_basename%.*}.html"

    pandoc \
        $pandoc_options \
        -f "$md_with_extensions" \
        -t revealjs \
        "$input_file" \
        -o "$output_file" &

    local pandoc_pid=$!
    echo Started Pandoc

    start_time=$(date +%s)
    while kill -0 $pandoc_pid &>/dev/null; do
        sleep 2
        printf 'Waiting for %s...\r' "$(date --date="@$(expr "$(date +%s)" - $start_time)" "+%M:%S")"
    done
    wait $pandoc_pid &>/dev/null # We don't wait at all here, we just call 'wait' to get the code.
    pandoc_exit_code=$?
    printf 'Took %s to run Pandoc!\n' "$(date --date="@$(expr "$(date +%s)" - $start_time)" "+%M:%S")"

    if [ "$pandoc_exit_code" -ne 0 ]; then
        notify-send \
            --urgency critical \
            -t -1 \
            "${0%%*/} @ $(realpath ${0%/*})" \
            'Failed Miserably'
    else
        notify-send \
            -t -1 \
            "${0%%*/} @ $(realpath ${0%/*})" \
            "Generated $output_file"
        echo "File generated at: $output_file"
    fi

    return "$pandoc_pid"
}


main "$@"
